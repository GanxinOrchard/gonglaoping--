# 柑心果園 - 購物車與結帳系統整合設定說明

## 📋 已完成的功能修正

### ✅ 1. 懸浮購物車數字顯示
- **問題**：加入商品時懸浮購物車按鈕的數字不會更新
- **解決**：修改 `js/cart.js` 的 `updateCartUI()` 函數，現在會同時更新所有購物車數量標記
- **位置**：第 167 行

### ✅ 2. 購物車頁面 Logo
- **問題**：購物車頁面左上角沒有顯示 logo
- **解決**：購物車頁面 (`cart.html`) 已經有完整的 header，包含 logo 和購物車圖示
- **位置**：cart.html 第 310-327 行

### ✅ 3. 結帳步驟指示器
- **問題**：步驟順序需要調整
- **解決**：已更新為：
  - 步驟 1：購物清單
  - 步驟 2：寄送付款方式
  - 步驟 3：完成訂單
- **位置**：checkout.html 第 535-548 行

### ✅ 4. 手機版購物車排版
- **問題**：手機版商品圖片和文字重疊
- **解決**：調整為垂直排列，圖片、資訊、控制按鈕分開顯示
- **位置**：cart.html 第 292-331 行（響應式 CSS）

### ✅ 5. 訂單摘要顯示
- **問題**：結帳頁面沒有顯示商品總金額和訂單總計
- **解決**：訂單摘要已包含：
  - 商品總金額
  - 折扣優惠（如有）
  - 運費
  - 訂單總計
- **位置**：checkout.html 第 583-598 行

### ✅ 6. 結帳頁面順序
- **問題**：需要調整為折扣碼、訂單摘要、配送方式的順序
- **解決**：已重新排列第一步驟的區塊順序
- **位置**：checkout.html 第 554-627 行

### ✅ 7. 運費動態計算
- **問題**：運費需要根據配送方式和折扣後金額動態變化
- **解決**：
  - 自取：運費 = 0
  - 宅配：折扣後金額 ≥ NT$1,800 免運，否則 NT$180
- **位置**：js/checkout.js 第 104-128 行

### ✅ 8. LINE Pay 與 GAS 整合
- **問題**：需要整合 LINE Pay 付款和 Google Sheets 訂單記錄
- **解決**：
  - 創建獨立的 LINE Pay 頁面 (`linepay.html`)
  - 整合 GAS 訂單提交功能
  - 選擇 LINE Pay 時會跳轉到專用頁面
- **位置**：js/checkout.js 第 440-495 行

---

## 🔧 需要設定的項目

### 1. Google Apps Script (GAS) 設定

#### 步驟 1：建立 Google 試算表
1. 前往 [Google Sheets](https://sheets.google.com)
2. 建立新試算表，命名為「柑心果園訂單管理」
3. 複製試算表 ID（在網址列中）
   ```
   https://docs.google.com/spreadsheets/d/[這裡是試算表ID]/edit
   ```

#### 步驟 2：設定 Apps Script
1. 在試算表中，點選「擴充功能」→「Apps Script」
2. 刪除預設代碼，貼上 `GAS-Backend.gs` 的內容
3. 修改以下設定：
   ```javascript
   const SPREADSHEET_ID = '您的試算表ID';
   const ADMIN_EMAIL = 'your-email@example.com'; // 管理員 Email
   ```

#### 步驟 3：部署為 Web App
1. 點選「部署」→「新增部署作業」
2. 選擇類型：「網頁應用程式」
3. 設定：
   - 說明：柑心果園訂單系統 API
   - 執行身分：我
   - 具有存取權的使用者：任何人
4. 點選「部署」
5. 複製「網頁應用程式 URL」

#### 步驟 4：更新前端代碼
在 `js/checkout.js` 第 441 行，將 URL 替換為您的 GAS URL：
```javascript
const GAS_WEB_APP_URL = '您的GAS_WEB_APP_URL';
```

---

### 2. LINE Pay 設定

#### 步驟 1：註冊 LINE Pay Merchant
1. 前往 [LINE Pay Merchant 註冊頁面](https://pay.line.me/tw/merchants/signup)
2. 填寫商家資訊並提交申請
3. 等待審核通過（約 3-5 個工作天）

#### 步驟 2：取得 API 金鑰
1. 登入 [LINE Pay Merchant Console](https://pay.line.me/portal/tw/main)
2. 前往「API 金鑰管理」
3. 記錄以下資訊：
   - Channel ID
   - Channel Secret Key

#### 步驟 3：設定後端 API
LINE Pay 需要後端伺服器處理付款請求，建議使用以下方案之一：

**方案 A：使用 Node.js + Express**
```javascript
// 範例代碼（需要在伺服器端執行）
const express = require('express');
const crypto = require('crypto');
const axios = require('axios');

const app = express();
const CHANNEL_ID = 'YOUR_CHANNEL_ID';
const CHANNEL_SECRET = 'YOUR_CHANNEL_SECRET';

app.post('/api/linepay/request', async (req, res) => {
  const { orderId, amount, productName } = req.body;
  
  const requestBody = {
    amount: amount,
    currency: 'TWD',
    orderId: orderId,
    packages: [{
      id: orderId,
      amount: amount,
      products: [{
        name: productName,
        quantity: 1,
        price: amount
      }]
    }],
    redirectUrls: {
      confirmUrl: 'https://your-domain.com/linepay/confirm',
      cancelUrl: 'https://your-domain.com/cart.html'
    }
  };
  
  // 生成簽章
  const nonce = Date.now().toString();
  const signature = crypto
    .createHmac('sha256', CHANNEL_SECRET)
    .update(CHANNEL_SECRET + '/v3/payments/request' + JSON.stringify(requestBody) + nonce)
    .digest('base64');
  
  try {
    const response = await axios.post(
      'https://sandbox-api-pay.line.me/v3/payments/request',
      requestBody,
      {
        headers: {
          'Content-Type': 'application/json',
          'X-LINE-ChannelId': CHANNEL_ID,
          'X-LINE-Authorization-Nonce': nonce,
          'X-LINE-Authorization': signature
        }
      }
    );
    
    res.json(response.data);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.listen(3000);
```

**方案 B：使用 Google Cloud Functions**
可以將上述邏輯部署到 Google Cloud Functions，無需維護伺服器。

#### 步驟 4：更新前端代碼
修改 `linepay.html` 的 `handleLinePayment()` 函數，呼叫您的後端 API。

---

## 📝 測試清單

### 購物車功能
- [ ] 加入商品後，懸浮購物車數字正確顯示
- [ ] 點擊懸浮購物車按鈕，跳轉到購物車頁面
- [ ] 購物車頁面顯示 logo
- [ ] 手機版商品排版正確，無重疊

### 結帳流程
- [ ] 步驟指示器顯示：購物清單 → 寄送付款方式 → 完成訂單
- [ ] 第一步順序：折扣碼 → 訂單摘要 → 配送方式
- [ ] 訂單摘要顯示：商品總金額、折扣、運費、訂單總計
- [ ] 套用折扣碼後，金額正確更新
- [ ] 選擇自取，運費顯示為 0
- [ ] 選擇宅配且金額 < NT$1,800，運費顯示 NT$180
- [ ] 選擇宅配且金額 ≥ NT$1,800，運費顯示免運費

### 付款流程
- [ ] 選擇銀行轉帳，正常完成訂單
- [ ] 選擇自取現金，正常完成訂單
- [ ] 選擇 LINE Pay，跳轉到 LINE Pay 頁面
- [ ] LINE Pay 頁面顯示正確的訂單資訊和金額

### GAS 整合（需先設定）
- [ ] 訂單成功提交到 Google Sheets
- [ ] 試算表中顯示完整訂單資訊
- [ ] 客戶收到訂單確認 Email
- [ ] 管理員收到新訂單通知 Email

---

## 🚀 部署建議

### 1. 本地測試
使用 Live Server 或類似工具在本地測試所有功能。

### 2. 部署到 GitHub Pages
```bash
git add .
git commit -m "更新購物車和結帳系統"
git push origin main
```

### 3. 設定自訂網域（選用）
在 GitHub Pages 設定中綁定您的網域。

---

## 📞 技術支援

如有任何問題，請檢查：
1. 瀏覽器控制台是否有錯誤訊息
2. GAS URL 是否正確設定
3. LINE Pay API 金鑰是否正確

---

## 📄 相關檔案

- `js/cart.js` - 購物車核心邏輯
- `js/checkout.js` - 結帳流程邏輯
- `cart.html` - 購物車頁面
- `checkout.html` - 結帳頁面
- `linepay.html` - LINE Pay 付款頁面
- `order-complete.html` - 訂單完成頁面
- `GAS-Backend.gs` - Google Apps Script 後端代碼

---

最後更新：2025-10-08
