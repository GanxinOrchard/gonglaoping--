<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購物車診斷工具</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #ff8c42;
            margin-top: 0;
        }
        .result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .ok {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        button {
            background: #ff8c42;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #e67e22;
        }
        .floating-cart-btn {
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            width: 60px !important;
            height: 60px !important;
            background: var(--primary-color) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 4px 12px rgba(255, 140, 66, 0.4) !important;
            cursor: pointer !important;
            z-index: 50000 !important;
        }
    </style>
</head>
<body>
    <h1>🔍 購物車功能診斷工具</h1>
    
    <div class="test-section">
        <h2>1. JavaScript 檔案載入檢查</h2>
        <div id="jsCheck"></div>
    </div>

    <div class="test-section">
        <h2>2. DOM 元素檢查</h2>
        <div id="domCheck"></div>
    </div>

    <div class="test-section">
        <h2>3. 事件監聽器測試</h2>
        <div id="eventCheck"></div>
        <button onclick="testClickEvent()">測試點擊事件</button>
    </div>

    <div class="test-section">
        <h2>4. 手動測試</h2>
        <button onclick="manualOpenCart()">手動開啟購物車</button>
        <button onclick="testAddToCart()">測試加入購物車</button>
        <div id="manualResult"></div>
    </div>

    <div class="test-section">
        <h2>5. 控制台日誌</h2>
        <div id="consoleLog" style="background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
    </div>

    <!-- 懸浮購物車按鈕 -->
    <div class="floating-cart-btn" id="floatingCartBtn">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge" id="floatingCartCount">0</span>
    </div>

    <!-- 購物車側邊欄 -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3>購物車</h3>
            <button class="close-cart" id="closeCart">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            <p>購物車是空的</p>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <div class="total">
                    <span>總計：</span>
                    <span id="total">NT$ 0</span>
                </div>
            </div>
            <button class="btn-checkout" id="checkoutBtn">前往結帳</button>
        </div>
    </div>

    <script src="./js/products.js"></script>
    <script src="./js/cart.js"></script>
    <script src="./js/main.js"></script>
    
    <script>
        // 攔截 console.log
        const originalLog = console.log;
        const originalError = console.error;
        const logDiv = document.getElementById('consoleLog');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logDiv.innerHTML += `<div style="color: #333;">[LOG] ${args.join(' ')}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logDiv.innerHTML += `<div style="color: #dc3545;">[ERROR] ${args.join(' ')}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        function checkJS() {
            const jsCheck = document.getElementById('jsCheck');
            let html = '';
            
            // 檢查 products
            if (typeof products !== 'undefined') {
                html += `<div class="result ok">✓ products.js 已載入 (${products.length} 個商品)</div>`;
            } else {
                html += `<div class="result error">✗ products.js 未載入或 products 變數不存在</div>`;
            }
            
            // 檢查 cart 相關函數
            if (typeof addToCart === 'function') {
                html += `<div class="result ok">✓ addToCart 函數存在</div>`;
            } else {
                html += `<div class="result error">✗ addToCart 函數不存在</div>`;
            }
            
            if (typeof updateCartUI === 'function') {
                html += `<div class="result ok">✓ updateCartUI 函數存在</div>`;
            } else {
                html += `<div class="result error">✗ updateCartUI 函數不存在</div>`;
            }
            
            jsCheck.innerHTML = html;
        }

        function checkDOM() {
            const domCheck = document.getElementById('domCheck');
            let html = '';
            
            const elements = {
                'floatingCartBtn': document.getElementById('floatingCartBtn'),
                'cartSidebar': document.getElementById('cartSidebar'),
                'closeCart': document.getElementById('closeCart'),
                'cartItems': document.getElementById('cartItems'),
                'cartCount': document.getElementById('floatingCartCount')
            };
            
            for (const [name, element] of Object.entries(elements)) {
                if (element) {
                    const style = window.getComputedStyle(element);
                    html += `<div class="result ok">✓ ${name} 存在 (display: ${style.display}, visibility: ${style.visibility})</div>`;
                } else {
                    html += `<div class="result error">✗ ${name} 不存在</div>`;
                }
            }
            
            domCheck.innerHTML = html;
        }

        function testClickEvent() {
            const eventCheck = document.getElementById('eventCheck');
            const btn = document.getElementById('floatingCartBtn');
            
            if (btn) {
                eventCheck.innerHTML = '<div class="result warning">正在測試點擊事件...</div>';
                
                // 模擬點擊
                btn.click();
                
                setTimeout(() => {
                    const sidebar = document.getElementById('cartSidebar');
                    if (sidebar && sidebar.classList.contains('active')) {
                        eventCheck.innerHTML = '<div class="result ok">✓ 點擊事件正常！購物車已開啟</div>';
                    } else {
                        eventCheck.innerHTML = '<div class="result error">✗ 點擊事件無效，購物車未開啟</div>';
                    }
                }, 500);
            } else {
                eventCheck.innerHTML = '<div class="result error">✗ 找不到購物車按鈕</div>';
            }
        }

        function manualOpenCart() {
            const result = document.getElementById('manualResult');
            const sidebar = document.getElementById('cartSidebar');
            
            if (sidebar) {
                sidebar.classList.add('active');
                result.innerHTML = '<div class="result ok">✓ 購物車已手動開啟</div>';
            } else {
                result.innerHTML = '<div class="result error">✗ 找不到購物車側邊欄</div>';
            }
        }

        function testAddToCart() {
            const result = document.getElementById('manualResult');
            
            if (typeof addToCart === 'function' && typeof products !== 'undefined' && products.length > 0) {
                try {
                    addToCart(products[0].id, null, 1);
                    result.innerHTML = '<div class="result ok">✓ 成功加入購物車！</div>';
                } catch (error) {
                    result.innerHTML = `<div class="result error">✗ 加入購物車失敗: ${error.message}</div>`;
                }
            } else {
                result.innerHTML = '<div class="result error">✗ addToCart 函數或商品資料不存在</div>';
            }
        }

        // 頁面載入後執行檢查
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('開始診斷...');
                checkJS();
                checkDOM();
                console.log('診斷完成');
            }, 1000);
        });

        // 監聽所有點擊事件
        document.addEventListener('click', (e) => {
            console.log('點擊事件:', e.target.id || e.target.className || e.target.tagName);
        }, true);
    </script>
</body>
</html>
